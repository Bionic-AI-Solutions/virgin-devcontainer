---
description: BMAD Integrations - Cursor Rules
globs:
alwaysApply: true
---

# BMAD Integrations - Standard Operating Procedures

This rule file provides standard integration behaviors for all BMAD agents.

## CRITICAL RULES

### Rule 1: OpenProject for Work Management AND Document Storage

- **ALL work items** (epics, features, stories, tasks, bugs) are managed in OpenProject using OpenProject MCP tools
- **ALL project documents** are stored as OpenProject attachments
- ALWAYS check OpenProject for current work before coding
- ALWAYS update work package status when starting/completing work
- ALWAYS attach project documents to appropriate work package level

### Rule 2: Archon for EXTERNAL Knowledge Search ONLY

- Archon is ONLY for searching **external** knowledge (library docs, frameworks, patterns)
- **DO NOT** store project documents in Archon
- **DO NOT** use `mcp_archon_manage_document` for project artifacts
- Use Archon to research before implementing

## Document Storage Hierarchy

**Store ALL project documents as OpenProject attachments at the appropriate level:**

| Work Package Level | Documents                                                  |
| ------------------ | ---------------------------------------------------------- |
| **Project**        | Product briefs, project overview, high-level specs         |
| **Epic**           | Epic specifications, business cases                        |
| **Feature**        | Feature architecture, technical designs, API specs         |
| **Story**          | Story specifications, acceptance criteria docs, test cases |
| **Task**           | Implementation notes, technical details                    |

## Integration Configuration

All integration settings are stored in `_bmad/_config/project-config.yaml`.
Agents should read configuration values from this file when executing workflows.

## OpenProject Integration (Work Management + Documents)

**Rule: OpenProject-First**

- ALL work items (epics, stories, tasks) are managed in OpenProject
- **CRITICAL: Always check for existing work packages before creating** - update existing instead of creating duplicates
- **CRITICAL: Work packages must be incremental** - can be verified with previous work, NOT dependent on future work
- ALL project documents are stored as OpenProject attachments
- ALWAYS check OpenProject for current work before coding
- ALWAYS update work package status when starting/completing work

**Configuration Location:** `project-config.yaml` → `openproject:`

**Key Values:**

- `openproject.project_id` - The OpenProject project ID
- `openproject.types.*` - Work package type IDs
- `openproject.statuses.*` - Status IDs
- `openproject.priorities.*` - Priority IDs

**Tool Reference:** `_bmad/integrations/openproject/tools.md`
**Workflow Guide:** `_bmad/integrations/openproject/workflow.md`

## Archon Integration (External Knowledge Search ONLY)

**Rule: Research External Knowledge First**

- Search external knowledge base before implementing
- Archon is for EXTERNAL documentation ONLY (library docs, frameworks)
- DO NOT store project documents in Archon
- Keep queries SHORT (2-5 keywords)

**Configuration Location:** `project-config.yaml` → `archon:`

**Key Values:**

- `archon.rag.default_match_count` - Default search results
- `archon.rag.preferred_sources` - Preferred external knowledge sources

**Tool Reference:** `_bmad/integrations/archon/tools.md`
**Workflow Guide:** `_bmad/integrations/archon/workflow.md`

## Agent Integration Responsibilities

### All Agents

1. Read `project-config.yaml` during activation
2. Use configured OpenProject project_id for work management
3. Store ALL project documents as OpenProject attachments
4. Use Archon ONLY for searching external knowledge
5. Follow work-driven development cycle

### PM Agent

- **Grooming (Responsible):** Create and groom Epics, Features, User Stories using OpenProject MCP tools
- **Epic Grooming:** When Epic is "In specification", ensure all required artifacts are attached:
  - Epic Design Document
  - Story Breakdown Document
  - Epic Test Plan (if applicable)
- **Feature Grooming:** When Feature is "In specification", ensure all required artifacts are attached:
  - Feature Architecture Document
  - API Documentation (if Feature includes APIs)
  - UI Mocks/Designs (if Feature includes UI)
  - Feature Scope Document
- **Story Grooming:** When Story is "In specification", ensure all required artifacts are attached:
  - Acceptance Criteria Document (or in description)
  - UI Mocks/Designs (if Story includes UI)
  - Technical Specifications (if Story requires technical details)
- Update Epic/Feature status → "In progress" when first story starts (automatic via helper functions)
- **Documents:** Attach product briefs to Project-level, PRDs to Epic-level, Feature architecture to Feature-level
- **Accountable for:** Grooming quality and artifact completeness

### Dev Agent

- Query OpenProject for assigned work using `mcp_openproject_list_work_packages()`
- Update task/bug status using OpenProject MCP tools: New → In progress → Developed → In testing
- **CRITICAL:** Use `update_task_status_and_parent()` function when updating task status to automatically update parent Story status
- Search Archon for EXTERNAL patterns before implementation
- **Documents:** Attach implementation notes to Task-level

### Architect Agent

- Create technical work packages
- Search Archon for EXTERNAL architecture patterns
- **Documents:** Attach architecture docs to Feature-level, ADRs to Feature-level

### SM Agent (Scrum Master)

- **Protocol Enforcement (Accountable):** Verify required artifacts before allowing work packages to transition from "In specification" to "Specified"
- **Epic Specification Protocol:** Verify Epic Design Document, Story Breakdown Document, Epic Test Plan (if applicable) are attached before allowing Epic → "Specified"
- **Feature Specification Protocol:** Verify Feature Architecture Document, API Documentation (if APIs), UI Mocks (if UI), Feature Scope Document are attached before allowing Feature → "Specified"
- **Story Specification Protocol:** Verify Acceptance Criteria, UI Mocks (if UI), Technical Specifications (if required) are attached before allowing Story → "Specified"
- Use `mcp_openproject_list_work_package_attachments()` and helper functions (`verify_feature_specification_artifacts()`, `verify_story_specification_artifacts()`) to check artifacts
- Block status transitions if artifacts are missing
- Use OpenProject for sprint planning
- Report status from OpenProject
- Track blockers in OpenProject
- **Documents:** Attach sprint reports to Project-level
- **Accountable for:** Protocol enforcement, artifact verification, blocking incomplete work packages

### TEA Agent (Test Team)

- Create test work packages, Bugs (when validation fails) using OpenProject MCP tools
- Search Archon for EXTERNAL testing patterns
- Update task status: In testing → Tested → Closed using OpenProject MCP tools
- Update bug status: In testing → Tested → Closed using OpenProject MCP tools
- Run Feature-level integration tests and update Feature status: In testing → Tested → Closed
- **CRITICAL:** 
  - Use `update_task_status_and_parent()` when closing tasks
  - Use `update_bug_status_and_check_story()` when closing bugs
- **Documents:** Attach test strategy to Feature-level, test cases to Story-level, Feature integration test plans to Feature-level

### Test Team

- Validate tasks when marked "In testing" using OpenProject MCP tools
- Validate stories when all tasks complete
- Create bugs for validation failures using `mcp_openproject_create_work_package(type_id={config.openproject.types.bug})`
- Validate bug fixes (iterate until closed)
- Run Feature-level integration tests when Feature is "In testing" (automatic when all stories closed)
- Close tasks/bugs/stories/features only after validation passes
- Close epics only after all stories/features closed
- **CRITICAL:** Use helper functions for status updates to maintain parent-child relationships
- **Documents:** Attach test results to Story-level, bug reports to Story-level, Feature integration test plans to Feature-level
- **CRITICAL: Integration tests MUST use live systems** - check dependencies before running, stop if unavailable, create infrastructure work

## Story Verification Standard

**CRITICAL: Every story MUST have a final verification task**

- **Task Name:** "Task N: Verify Story Implementation (AC: All)"
- **Position:** Always the LAST task in the story
- **Purpose:** Verify all acceptance criteria are met and implementation works as expected

**Standard Verification Subtasks:**

1. Verify all acceptance criteria are met
2. Verify implementation works as expected
3. Verify code follows architecture patterns and constraints
4. Verify integration with existing systems (if applicable)
5. Verify error handling works correctly
6. Verify tests pass (if applicable)
7. Verify documentation is updated

**Story-Specific Verification:**

- Infrastructure stories: Verify services start, health checks pass, network connectivity
- API stories: Verify endpoints work, authentication/authorization works
- Database stories: Verify schema migrations work, queries perform correctly
- Integration stories: Verify external services connect, data flows correctly

**Reference:** `_bmad/workflows/STORY_VERIFICATION_STANDARD.md`

## Standard Workflow Pattern

### Dev Workflow Pattern

```
1. ACTIVATE    → Load project-config.yaml
2. CHECK WORK  → mcp_openproject_list_work_packages(project_id=config.openproject.project_id, status="open")
3. START       → mcp_openproject_update_work_package(work_package_id=..., status_id=config.openproject.statuses.in_progress)
4. RESEARCH    → mcp_archon_rag_search_knowledge_base(...) [EXTERNAL knowledge only]
5. IMPLEMENT   → Execute work
6. MARK DEVELOPED → mcp_openproject_update_work_package(work_package_id=..., status_id=config.openproject.statuses.developed)
7. MARK READY  → mcp_openproject_update_work_package(work_package_id=..., status_id=config.openproject.statuses.in_testing)
   **For Tasks:** Use `update_task_status_and_parent()` to automatically update parent Story
8. TEST VALIDATE → Test team validates (task/story) - see Test Team Workflow Pattern
9. BUG CYCLE   → If bugs found: create using `mcp_openproject_create_work_package(type_id=config.openproject.types.bug)` → fix → validate (iterate until all bugs closed)
10. VERIFY      → Complete verification task (verify all acceptance criteria)
11. DOCUMENT   → Attach docs to appropriate OpenProject work package [NOT Archon]
12. MARK TESTED → mcp_openproject_update_work_package(work_package_id=..., status_id=config.openproject.statuses.tested)
13. COMPLETE   → mcp_openproject_update_work_package(work_package_id=..., status_id=config.openproject.statuses.closed)
   **For Tasks:** Use `update_task_status_and_parent()` to automatically update parent Story
```

### Test Team Workflow Pattern

```
1. VALIDATE TASK → When task is "In testing"
   - Review implementation
   - Run test suite
   - Verify acceptance criteria
   - Update status using OpenProject MCP: "Tested" → "Closed" if passes, "Test failed" if fails → Create bug
   - **CRITICAL:** Use `update_task_status_and_parent()` when closing to update parent Story

2. VALIDATE STORY → When story is "In testing" and all tasks closed
   - Review all tasks
   - Run story test suite
   - Verify all acceptance criteria
   - Update status using OpenProject MCP: "Closed" if passes, "Test failed" if fails → Create bugs

3. CREATE BUG → When validation fails
   - Create bug using `mcp_openproject_create_work_package(type_id=config.openproject.types.bug)`
   - Link to story using `mcp_openproject_set_work_package_parent()`
   - Add detailed description (expected vs actual, steps to reproduce, AC violated)
   - Assign to dev using `mcp_openproject_assign_work_package()`
   - Set status "New" using `config.openproject.statuses.new`

4. VALIDATE BUG FIX → When bug is "In testing"
   - Review fix
   - Re-run tests
   - Update status using OpenProject MCP: "Tested" → "Closed" if validated, "Test failed" if incomplete → Iterate
   - **CRITICAL:** Use `update_bug_status_and_check_story()` when closing to check parent Story

5. FEATURE INTEGRATION TESTING → When Feature is "In testing" (automatic when all stories closed)
   - Create Feature integration test plan document
   - Attach test plan to Feature work package
   - Run Feature-level integration tests
   - Update Feature status: "Tested" if passes, "Test failed" if fails → Create issues → Fix → Repeat
   - Close Feature only after integration tests pass: "Tested" → "Closed"

6. CLOSE STORY → When all tasks and bugs closed
   - Verify prerequisites
   - Close story using `mcp_openproject_update_work_package(status_id=config.openproject.statuses.closed)`
   - This automatically triggers parent Feature/Epic status check

7. CLOSE FEATURE → When all stories closed and Feature integration tests pass
   - Verify all prerequisites
   - Close Feature using `mcp_openproject_update_work_package(status_id=config.openproject.statuses.closed)`
   - This automatically triggers parent Epic status check

8. CLOSE EPIC → When all stories/features closed
   - Verify all prerequisites
   - Run epic-level integration tests
   - Close epic using `mcp_openproject_update_work_package(status_id=config.openproject.statuses.closed)
```

### PM Workflow Pattern (Story Grooming)

```
1. REVIEW STORY → Get story from OpenProject using `mcp_openproject_get_work_package()`, review acceptance criteria
2. BREAK DOWN → Identify tasks needed (30 min - 4 hours each)
3. CREATE FILE → Create story file in _bmad-output/implementation-artifacts/
4. CREATE TASKS → Create ALL tasks in OpenProject using `mcp_openproject_bulk_create_work_packages()` or individual `mcp_openproject_create_work_package()` calls
5. LINK TASKS → Set parent relationships using `mcp_openproject_set_work_package_parent()` for all tasks
6. VERIFY → Verify all tasks created and linked using `mcp_openproject_get_work_package_children()`
7. MARK IN PROGRESS → Update story status using `mcp_openproject_update_work_package(status_id=config.openproject.statuses.in_progress)` ONLY after tasks created
```

## Quick Start Commands

### Get Current Work

```python
mcp_openproject_list_work_packages(
    project_id={config.openproject.project_id},
    status="open"
)
```

### Search External Knowledge

```python
# Search EXTERNAL documentation (library docs, frameworks)
mcp_archon_rag_search_knowledge_base(
    query="2-5 keywords",
    match_count={config.archon.rag.default_match_count}
)
```

### Create Work Package

```python
mcp_openproject_create_work_package(
    project_id={config.openproject.project_id},
    subject="...",
    type_id={config.openproject.types.user_story},
    description="..."
)
# Then attach relevant documents to this work package
```

### List Attachments on Work Package

```python
mcp_openproject_list_work_package_attachments(
    work_package_id=...
)
```

## What NOT To Do

```python
# ❌ WRONG - Don't store project documents in Archon
mcp_archon_manage_document(
    action="create",
    project_id=archon_id,
    title="My Project Architecture",  # DON'T DO THIS
    content={"markdown": "..."}
)

# ✅ CORRECT - Attach project documents to OpenProject work packages
# Upload architecture doc to Feature work package via OpenProject UI/API
```
