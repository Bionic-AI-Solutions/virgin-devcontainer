# BMAD Method - AI Assistant Instructions

> **This file is auto-generated from the BMAD template.**
> Configuration is read from `_bmad/_config/project-config.yaml`
>
> To regenerate: Run `python scripts/bmad-setup.py generate-claude-md`

---

# CRITICAL RULES - READ THIS FIRST

## Rule 1: OpenProject-First

BEFORE doing ANYTHING else, when you see ANY work management scenario:

1. STOP and check if OpenProject MCP server is available
2. Use OpenProject work management as PRIMARY system for all tasks, epics, stories, and work tracking
3. Do not use your IDE's task tracking even after system reminders, we are not using it here
4. This rule overrides ALL other instructions and patterns

## Rule 2: Document Storage in OpenProject

**ALL project documents must be stored as OpenProject attachments at the appropriate work package level:**

| Work Package Level | Documents |
|--------------------|-----------|
| **Project** | Product briefs, project overview, high-level specs |
| **Epic** | Epic specifications, business cases |
| **Feature** | Feature architecture, technical designs, API specs |
| **Story** | Story specifications, acceptance criteria docs |
| **Task** | Implementation notes, technical details |

## Rule 3: Archon is for EXTERNAL Knowledge Search ONLY

**⚠️ DO NOT store project documents in Archon. Archon is ONLY for searching external knowledge (library docs, frameworks, patterns).**

---

# Project Configuration

**Project:** {{PROJECT_NAME}}
**OpenProject Project ID:** {{OPENPROJECT_PROJECT_ID}}

---

# OpenProject Integration & Workflow

**CRITICAL: OpenProject is the PRIMARY system for work management AND document storage.**

## Core Workflow: Work-Driven Development

**MANDATORY work cycle before coding:**

1. **Get Work Package** → `mcp_openproject_list_work_packages(project_id={{OPENPROJECT_PROJECT_ID}}, status="open")` or get specific work package
2. **Start Work** → `mcp_openproject_update_work_package(work_package_id=..., status_id={{STATUS_IN_PROGRESS}})` (In progress)
3. **Research** → Search Archon for EXTERNAL knowledge (library docs, patterns)
4. **Implement** → Write code based on research
5. **Document** → Attach implementation docs to appropriate work package
6. **Review** → `mcp_openproject_update_work_package(work_package_id=..., status_id={{STATUS_IN_TESTING}})` (In testing)
7. **Complete** → `mcp_openproject_update_work_package(work_package_id=..., status_id={{STATUS_CLOSED}})` (Closed)
8. **Next Work** → `mcp_openproject_list_work_packages(project_id={{OPENPROJECT_PROJECT_ID}}, status="open")`

**NEVER skip work package updates. NEVER code without checking current work packages first.**

## Document Storage Workflow

When creating project documents:

1. **Identify Document Type** → What kind of document is it?
2. **Determine Level** → Which work package level should it attach to?
3. **Attach to Work Package** → Upload via OpenProject UI or API

| Document Type | Attach To |
|---------------|-----------|
| Product Brief | Project-level work package |
| PRD | Epic-level work package |
| Architecture Doc | Feature-level work package |
| Technical Spec | Feature/Story-level work package |
| Implementation Notes | Task-level work package |
| Test Strategy | Feature-level work package |
| Test Cases | Story-level work package |

---

# Archon External Knowledge Search

**IMPORTANT: Archon is ONLY for searching EXTERNAL knowledge (library docs, frameworks, patterns). NOT for storing project documents.**

## Research Before Implementation

1. **Search External Knowledge** → `mcp_archon_rag_search_knowledge_base(query="2-5 keywords", match_count=5)`
2. **Find External Code Examples** → `mcp_archon_rag_search_code_examples(query="2-5 keywords", match_count=3)`
3. **Read Full External Pages** → `mcp_archon_rag_read_full_page(page_id=...)`

## Searching Specific External Documentation

1. **Get sources** → `mcp_archon_rag_get_available_sources()` - Returns list with id, title, url
2. **Find source ID** → Match to external documentation (e.g., "React docs" → "src_abc123")
3. **Search** → `mcp_archon_rag_search_knowledge_base(query="hooks state", source_id="src_abc123")`

---

# Tool Reference

## OpenProject (Work Management + Document Storage - PRIMARY)

| Tool | Description |
|------|-------------|
| `mcp_openproject_list_projects()` | List all projects |
| `mcp_openproject_get_project(project_id={{OPENPROJECT_PROJECT_ID}})` | Get this project |
| `mcp_openproject_list_work_packages(project_id={{OPENPROJECT_PROJECT_ID}}, status="open")` | List open work |
| `mcp_openproject_get_work_package(work_package_id=...)` | Get work package details |
| `mcp_openproject_create_work_package(...)` | Create epic/story/task |
| `mcp_openproject_update_work_package(...)` | Update work package |
| `mcp_openproject_set_work_package_parent(...)` | Set parent relationship |
| `mcp_openproject_list_work_package_attachments(work_package_id=...)` | List attachments |
| `mcp_openproject_add_work_package_comment(...)` | Add comment |

## Work Package Type IDs

| Type | ID |
|------|-----|
| Epic | {{TYPE_EPIC}} |
| Feature | {{TYPE_FEATURE}} |
| User Story | {{TYPE_USER_STORY}} |
| Task | {{TYPE_TASK}} |
| Bug | {{TYPE_BUG}} |

## Status IDs

| Status | ID |
|--------|-----|
| New | {{STATUS_NEW}} |
| In specification | {{STATUS_IN_SPECIFICATION}} |
| Specified | {{STATUS_SPECIFIED}} |
| In progress | {{STATUS_IN_PROGRESS}} |
| Developed | {{STATUS_DEVELOPED}} |
| In testing | {{STATUS_IN_TESTING}} |
| Tested | {{STATUS_TESTED}} |
| Test failed | {{STATUS_TEST_FAILED}} |
| Closed | {{STATUS_CLOSED}} |
| On hold | {{STATUS_ON_HOLD}} |
| Rejected | {{STATUS_REJECTED}} |

## Priority IDs

| Priority | ID |
|----------|-----|
| Low | {{PRIORITY_LOW}} |
| Normal | {{PRIORITY_NORMAL}} |
| High | {{PRIORITY_HIGH}} |
| Immediate | {{PRIORITY_IMMEDIATE}} |

---

## Archon (External Knowledge Search ONLY)

| Tool | Description |
|------|-------------|
| `mcp_archon_rag_get_available_sources()` | List external knowledge sources |
| `mcp_archon_rag_search_knowledge_base(...)` | Search external knowledge |
| `mcp_archon_rag_search_code_examples(...)` | Find external code examples |
| `mcp_archon_rag_read_full_page(...)` | Read external page content |

**⚠️ DO NOT use `mcp_archon_manage_document` for project documents. Store them as OpenProject attachments.**

---

# Important Notes

- Work package status flow: New → In progress → Developed → In testing → Tested → Closed
- Feature status flow: New → In progress → In testing (when all stories closed) → Tested (after integration tests) → Closed
- Bug status flow: New → In progress → Developed → In testing → Tested → Closed
- Keep RAG queries SHORT (2-5 keywords) for better search results
- Higher priority_id = higher priority (Low={{PRIORITY_LOW}}, Normal={{PRIORITY_NORMAL}}, High={{PRIORITY_HIGH}}, Immediate={{PRIORITY_IMMEDIATE}})
- Stories should be {{STORY_MIN_HOURS}} - {{STORY_MAX_HOURS}} hours of work
- **ALL project documents → OpenProject attachments at appropriate level**
- **Archon → Search EXTERNAL knowledge only (library docs, patterns)**

---

# BMAD Methodology Integration

## System Architecture

| System | Responsibility |
|--------|----------------|
| **OpenProject** | Work management + ALL project documents (attachments) |
| **Archon** | Search EXTERNAL knowledge only |

## Document Storage Hierarchy

| BMAD Artifact | OpenProject Level | Document Types |
|---------------|-------------------|----------------|
| **Project** | Project-level | Product briefs, overview docs |
| **Epic** | Epic WP | Epic specs, business cases |
| **Feature** | Feature WP | Architecture, technical designs |
| **Story** | Story WP | Acceptance criteria, test cases |
| **Task** | Task WP | Implementation notes |

## Work Package Creation Patterns

### Creating an Epic

**CRITICAL: Always check for existing Epic before creating**

```python
# Check for existing Epic
def check_existing_epic(project_id: int, epic_subject: str) -> dict | None:
    """Check if Epic already exists in OpenProject."""
    epics = mcp_openproject_list_work_packages(
        project_id=project_id,
        filters=json.dumps([
            {"type": {"operator": "=", "values": [{{TYPE_EPIC}}]}}
        ]),
        status="all"  # Include closed epics
    )
    for epic in epics.get("work_packages", []):
        if epic_subject.lower() in epic["subject"].lower() or epic["subject"].lower() in epic_subject.lower():
            return epic
    return None

epic_subject = "Epic N: Epic Name"
existing_epic = check_existing_epic(project_id={{OPENPROJECT_PROJECT_ID}}, epic_subject=epic_subject)

if existing_epic:
    # Update existing Epic
    epic = mcp_openproject_update_work_package(
        work_package_id=existing_epic["id"],
        description="Updated business goal and scope"
    )
    epic_id = existing_epic["id"]
else:
    # Create new Epic
    epic = mcp_openproject_create_work_package(
        project_id={{OPENPROJECT_PROJECT_ID}},
        subject=epic_subject,
        type_id={{TYPE_EPIC}},
        description="Business goal and scope",
        status_id={{STATUS_NEW}},
        priority_id={{PRIORITY_HIGH}}
    )
    epic_id = epic["work_package"]["id"]
# Attach epic specification document to this work package

# MANDATORY: Create Test Story (Story X.T) for Epic
# This must be created when creating the Epic or during Epic grooming
test_story = mcp_openproject_create_work_package(
    project_id={{OPENPROJECT_PROJECT_ID}},
    subject="Story N.T: Epic N Testing and Validation",  # MANDATORY Test Story
    type_id={{TYPE_USER_STORY}},
    description="""
    As a **Test Team**,
    I want **to validate the complete Epic N functionality**,
    So that **I can ensure all stories work together and the Epic meets its acceptance criteria**.
    
    **Acceptance Criteria:**
    - **Given** all stories in Epic N are implemented
    - **When** I run Epic-level integration tests
    - **Then** all Epic acceptance criteria are met
    - **And** all cross-story integration points work correctly
    - **And** end-to-end Epic functionality is validated
    
    **Test Activities:**
    1. Create Epic test plan: `epic-N-test-plan.md`
    2. Attach test plan to Epic N
    3. Run Epic-level integration tests
    4. Validate all Epic acceptance criteria
    5. Test cross-story integration points
    6. Run end-to-end Epic functionality tests
    """,
    status_id={{STATUS_NEW}},
    priority_id={{PRIORITY_HIGH}}
)
mcp_openproject_set_work_package_parent(
    work_package_id=test_story["work_package"]["id"],
    parent_id=epic["work_package"]["id"]
)
```

### Creating a Feature (Recommended for new epics)

**CRITICAL: Always check for existing Feature before creating**

```python
# Check for existing Feature
def check_existing_feature(epic_id: int, feature_subject: str) -> dict | None:
    """Check if Feature already exists under Epic."""
    children = mcp_openproject_get_work_package_children(
        parent_id=epic_id,
        status="all"  # Include closed features
    )
    for child in children.get("children", []):
        if child["type"] == "Feature":
            if feature_subject.lower() in child["subject"].lower() or child["subject"].lower() in feature_subject.lower():
                return child
    return None

feature_subject = "Feature: Feature Name"
existing_feature = check_existing_feature(epic_id=epic_id, feature_subject=feature_subject)

if existing_feature:
    # Update existing Feature
    feature = mcp_openproject_update_work_package(
        work_package_id=existing_feature["id"],
        description="""
        ## Functional Capability
        {Updated statement of what this feature provides}
        
        ## Scope
        **Included:** {Updated stories and functionality included}
        **Excluded:** {Updated functionality explicitly excluded}
        
        ## Integration Test Scope
        {Updated what will be tested at Feature level}
        """
    )
    feature_id = existing_feature["id"]
else:
    # Create new Feature
    feature = mcp_openproject_create_work_package(
        project_id={{OPENPROJECT_PROJECT_ID}},
        subject=feature_subject,
        type_id={{TYPE_FEATURE}},
        description="""
        ## Functional Capability
        {Clear statement of what this feature provides}
        
        ## Scope
        **Included:** {Stories and functionality included}
        **Excluded:** {Functionality explicitly excluded}
        
        ## Integration Test Scope
        {What will be tested at Feature level}
        """,
        status_id={{STATUS_NEW}},
        priority_id={{PRIORITY_HIGH}}
    )
    feature_id = feature["work_package"]["id"]
    # Set parent to Epic
    mcp_openproject_set_work_package_parent(
        work_package_id=feature_id,
        parent_id=epic_id
    )
# Attach architecture document to Feature

# MANDATORY: Create Integration Test Story (Story X.Y.T) for Feature
# This must be created when creating the Feature or during Feature grooming
integration_test_story = mcp_openproject_create_work_package(
    project_id={{OPENPROJECT_PROJECT_ID}},
    subject="Story X.Y.T: Feature X.Y Integration Testing and Validation",  # MANDATORY Integration Test Story
    type_id={{TYPE_USER_STORY}},
    description="""
    As a **Test Team**,
    I want **to validate the complete Feature X.Y functionality**,
    So that **I can ensure all stories work together and the Feature meets its acceptance criteria**.
    
    **Acceptance Criteria:**
    - **Given** all stories in Feature X.Y are implemented
    - **When** I run Feature-level integration tests
    - **Then** all Feature acceptance criteria are met
    - **And** all cross-story integration points work correctly
    - **And** end-to-end Feature functionality is validated
    
    **Test Activities:**
    1. Create Feature integration test plan: `feature-X-Y-integration-test-plan.md`
    2. Attach test plan to Feature X.Y
    3. Run Feature-level integration tests
    4. Validate all Feature acceptance criteria
    5. Test cross-story integration points
    6. Run end-to-end Feature functionality tests
    """,
    status_id={{STATUS_NEW}},
    priority_id={{PRIORITY_HIGH}}
)
mcp_openproject_set_work_package_parent(
    work_package_id=integration_test_story["work_package"]["id"],
    parent_id=feature["work_package"]["id"]
)
```

### Creating a User Story

**CRITICAL: Always check for existing Story before creating**

**CRITICAL: INCREMENTAL DEVELOPMENT** - Story must be verifiable with previous work, NOT dependent on future work.

```python
# Check for existing Story
def check_existing_story(parent_id: int, story_subject: str) -> dict | None:
    """Check if Story already exists under parent (Feature or Epic)."""
    children = mcp_openproject_get_work_package_children(
        parent_id=parent_id,
        status="all"  # Include closed stories
    )
    for child in children.get("children", []):
        if child["type"] == "User story":
            if story_subject.lower() in child["subject"].lower() or child["subject"].lower() in story_subject.lower():
                return child
    return None

story_subject = "Story N.M: Story Name"  # Or "Story N.F.M" if under Feature
parent_id = feature_id  # Or epic_id if no Features
existing_story = check_existing_story(parent_id=parent_id, story_subject=story_subject)

if existing_story:
    # Update existing Story
    story = mcp_openproject_update_work_package(
        work_package_id=existing_story["id"],
        description="""
        As a {updated_persona},
        I want {updated_goal},
        So that {updated_benefit}.
        
        **Acceptance Criteria:**
        Given... When... Then...
        """
    )
    story_id = existing_story["id"]
else:
    # Create new Story
    story = mcp_openproject_create_work_package(
        project_id={{OPENPROJECT_PROJECT_ID}},
        subject=story_subject,
        type_id={{TYPE_USER_STORY}},
        description="""
        As a {persona},
        I want {goal},
        So that {benefit}.
        
        **Acceptance Criteria:**
        Given... When... Then...
        """,
        status_id={{STATUS_NEW}},
        priority_id={{PRIORITY_NORMAL}}
    )
    story_id = story["work_package"]["id"]
    # Set parent to Feature (if Features exist) or Epic (if no Features)
    mcp_openproject_set_work_package_parent(
        work_package_id=story_id,
        parent_id=parent_id
    )
# Attach detailed acceptance criteria doc to this work package

# MANDATORY: Create test task (Task X.Y.T) for Story
# This must be created during story grooming
test_task = mcp_openproject_create_work_package(
    project_id={{OPENPROJECT_PROJECT_ID}},
    subject="Task N.M.T: Story N.M Testing and Validation",  # MANDATORY test task
    type_id={{TYPE_TASK}},
    description="""
    **MANDATORY Test Task for Story N.M**
    
    **CRITICAL:** This test task MUST be completed and closed before the Story can be closed.
    
    **Activities:**
    1. Create Story test document: `story-N-M-test-plan.md`
    2. Attach test document to Story N.M
    3. Validate all acceptance criteria
    4. Run integration tests
    5. Verify implementation works as expected
    6. Verify code follows architecture patterns
    7. Verify error handling works correctly
    8. Verify documentation is updated
    """,
    status_id={{STATUS_NEW}},
    priority_id={{PRIORITY_HIGH}}  # High priority - required for story closure
)
mcp_openproject_set_work_package_parent(
    work_package_id=test_task["work_package"]["id"],
    parent_id=story["work_package"]["id"]
)
```

### Creating a Task
```python
task = mcp_openproject_create_work_package(
    project_id={{OPENPROJECT_PROJECT_ID}},
    subject="Task N.M.P: Task Name",  # Or "Task N.F.M.P" if Story is under Feature
    type_id={{TYPE_TASK}},
    description="Implementation details",
    status_id={{STATUS_NEW}}
)
mcp_openproject_set_work_package_parent(
    work_package_id=task["work_package"]["id"],
    parent_id=story_id
)
# CRITICAL: Always use update_task_status_and_parent() when updating task status
# This automatically updates parent Story status
```

### Creating a Bug
```python
bug = mcp_openproject_create_work_package(
    project_id={{OPENPROJECT_PROJECT_ID}},
    subject="Bug: Brief Description",
    type_id={{TYPE_BUG}},
    description="""
    **Bug Report:**
    
    **Story:** {Story ID and Title}
    **Task:** {Task ID and Title} (if applicable)
    
    **Expected Behavior:**
    {What should happen}
    
    **Actual Behavior:**
    {What actually happens}
    
    **Steps to Reproduce:**
    1. {Step 1}
    2. {Step 2}
    3. {Step 3}
    
    **Acceptance Criteria Violated:**
    - {AC 1}
    - {AC 2}
    """,
    status_id={{STATUS_NEW}},
    priority_id={{PRIORITY_NORMAL}}  # Adjust based on impact
)
mcp_openproject_set_work_package_parent(
    work_package_id=bug["work_package"]["id"],
    parent_id=story_id
)
# Assign bug to dev
mcp_openproject_assign_work_package(
    work_package_id=bug["work_package"]["id"],
    assignee_id=dev_user_id
)
# CRITICAL: Always use update_bug_status_and_check_story() when closing bugs
# This automatically checks if parent Story can be closed
```

---

# Agent Responsibilities

## PM Agent
- **Grooming (Responsible):** Creates and grooms Epics, Features, User Stories from PRD
- **Epic Grooming:** When Epic is "In specification", ensures all required artifacts are attached:
  - Epic Design Document
  - Story Breakdown Document
  - Epic Test Plan (if applicable)
- **Feature Grooming:** When Feature is "In specification", ensures all required artifacts are attached:
  - Feature Architecture Document
  - API Documentation (if Feature includes APIs)
  - UI Mocks/Designs (if Feature includes UI)
  - Feature Scope Document
- **Story Grooming:** When Story is "In specification", ensures all required artifacts are attached:
  - Acceptance Criteria Document (or in description)
  - UI Mocks/Designs (if Story includes UI)
  - Technical Specifications (if Story requires technical details)
- Maintains Feature/Story acceptance criteria
- Queries sprint backlog and status
- Updates Epic/Feature status: → "In progress" (when first story starts)
- **Documents:** Attaches product briefs to Project, PRDs to Epic, Feature architecture to Feature
- **Accountable for:** Grooming quality and artifact completeness

## Dev Agent
- Queries assigned work packages (tasks, bugs)
- Updates task status: New → In progress → Developed → In testing
- Updates bug status: New → In progress → Developed → In testing
- **CRITICAL:** Uses `update_task_status_and_parent()` function to automatically update parent Story status
- Logs time against work packages
- **Documents:** Attaches implementation notes to Task

## SM Agent (Scrum Master)
- **Protocol Enforcement (Accountable):** Verifies required artifacts before allowing work packages to transition from "In specification" to "Specified"
- **Epic Specification Protocol:** Verifies Epic Design Document, Story Breakdown Document, Epic Test Plan (if applicable) are attached before allowing Epic → "Specified"
- **Feature Specification Protocol:** Verifies Feature Architecture Document, API Documentation (if APIs), UI Mocks (if UI), Feature Scope Document are attached before allowing Feature → "Specified"
- **Story Specification Protocol:** Verifies Acceptance Criteria, UI Mocks (if UI), Technical Specifications (if required) are attached before allowing Story → "Specified"
- Uses `mcp_openproject_list_work_package_attachments()` and helper functions to check artifacts
- Blocks status transitions if artifacts are missing
- Sprint planning and assignment
- Status reporting
- Blocker management
- **Documents:** Attaches sprint reports to Project
- **Accountable for:** Protocol enforcement, artifact verification, blocking incomplete work packages

## Architect Agent
- Creates technical tasks
- Links stories to specifications
- **Documents:** Attaches architecture docs to Feature, system design to Project

## TEA Agent (Test Team)
- Creates test tasks, Bugs (when validation fails)
- Updates task status: In testing → Tested → Closed
- Updates bug status: In testing → Tested → Closed
- Updates Feature status: In testing → Tested → Closed (after Feature integration tests)
- **CRITICAL:** 
  - Uses `update_task_status_and_parent()` when closing tasks
  - Uses `update_bug_status_and_check_story()` when closing bugs
  - Runs Feature-level integration tests and updates Feature status
- **Documents:** Attaches test strategy to Feature, test cases to Story, Feature integration test plans to Feature

---

# Quick Reference

## Start of Day
```python
# Get my open work
mcp_openproject_list_work_packages(
    project_id={{OPENPROJECT_PROJECT_ID}},
    status="open"
)
```

## Starting Work on a Task
```python
# Mark as in progress
mcp_openproject_update_work_package(
    work_package_id=task_id,
    status_id={{STATUS_IN_PROGRESS}}
)

# Research EXTERNAL knowledge first
mcp_archon_rag_search_knowledge_base(query="relevant keywords")
```

## Completing Work
```python
# Attach implementation notes to task (via OpenProject UI/API)

# Move to testing
mcp_openproject_update_work_package(
    work_package_id=task_id,
    status_id={{STATUS_IN_TESTING}}
)

# After review passes
mcp_openproject_update_work_package(
    work_package_id=task_id,
    status_id={{STATUS_CLOSED}}
)
```

---

# Documentation References

For detailed documentation:
- OpenProject (Work + Documents): `_bmad/integrations/openproject/`
- Archon (External Search): `_bmad/integrations/archon/`
- Project Config: `_bmad/_config/project-config.yaml`
